# scATAC preprocessing
## Python script for the preprocessing of 10X scATACSeq experiments processed with CellRanger

/// --------------------------------------- ///

### DEPENDENCIES

Python 3.9.16+ &

	gzip
	numpy
	os (listdir, makedirs)
	pandas
	scipy.sparse (csr_matrix, dok_matrix, save_npz)

/// --------------------------------------- ///

### WORKFLOW

#### Manual execution

Since the calling is done for each sample separately by CellRanger, ATAC peaks are not the same for all samples.

To fix this, we need to:

1. Create a bed file with consensus peaks using the following bedtools command:

```shell
	cat *atac_peaks.bed | cut -f1-3 | sort -k1,1 -k2,2n | bedtools merge -i - > consensus_peaks.bed
```

2. Quantify expression using the included **quantify_peaks_counts.sh** script

3. Aggregate cell counts using the uncluded **aggregate_peaks_counts.py** script

4. Use the **integrated_analysis** module for downstream analyses

#### Nextflow

Steps 1-3 above have been automated using Nextflow.

To run the pipeline, use:

	nextflow run main.nf -profile [docker/singularity/podman] --samples_manifest_file /path/to/sample/manifest

The input to the pipeline is a tab-separated file with the following required columns:

* **sample_id**: unique sample identifier

* **peaks_bed**: path to bedfile for sample specific peaks

* **barcodes**: path to text file with cell barcodes to process for individual samples

* **fragments**: path to bed-like file with ATAC fragments for each barcodes of a sample

/// --------------------------------------- ///

### Scripts

#### quantify_peaks_counts.sh

This script quantifies the counts for ATAC peaks for single-cell data.

Parameters:

	barcodes
		File generated by cellranger-arc with unique barcodes
	peaks_fragment
		File generated by cellranger-arc with unique, barcoded ATAC fragments
	consensus_peaks
		Path to bed file with coordinate of (consensus) ATAC peaks
	sample_name (optional)
	    Name to be used as prefix for output files

#### aggregate_peaks_counts.py

This script aggregate the counts for ATAC peaks for individual cells and saved data in MEX format.

Parameters:

	-sample_name (optional)
    	Name to be used as prefix for output files
	--cov_dir
	    Path to directory containing coverage files generated by quantify_peaks_counts.sh
	--min_detected_fragments (optional)
	    Minimum number of total fragments a cell must have to be kept
	    Default = 500
	--min_detected_peaks (optional)
	    Minimum number of peaks a cell must have to be kept
	    Default = 500
